{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block extrahead %}
  {{ block.super }}
  <style>
    /* Brand Color */
    :root{ --brand:#7c3aed; --brand-weak:#ede9fe; }          /* violet-600 */
    html.dark{ --brand:#8b5cf6; --brand-weak:#1f1633; }      /* little brighter in dark */

    .dash-grid { display:grid; gap:1rem; }
    @media (min-width: 768px){ .dash-grid.cols-4{ grid-template-columns:repeat(4,minmax(0,1fr)); } }
    @media (min-width: 768px){ .dash-grid.cols-5{ grid-template-columns:repeat(5,minmax(0,1fr)); } }

    .dash-card{
      border-radius:12px; padding:16px; border:1px solid var(--color-border,#e5e7eb);
      background: var(--color-surface,#ffffff);
      transition: background .2s,color .2s,border-color .2s, box-shadow .2s;
    }
    .dash-card h3{ margin:0; font-size:.875rem; color: var(--color-muted,#6b7280); }
    .dash-card .value{ margin-top:.35rem; font-weight:700; font-size:1.6rem; color: var(--color-strong,#111827); }
    .dash-card .sub{ margin-top:.25rem; font-size:.75rem; color: var(--color-muted,#6b7280); }
    .accent { border-left:4px solid var(--brand); padding-left:12px; }
    .brand-chip{
      display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .55rem; border-radius:999px;
      background: var(--brand-weak); color: var(--brand); font-size:.75rem; border:1px solid var(--brand);
    }

    /* table */
    .dash-table{ width:100%; font-size:.875rem; border-collapse:collapse; }
    .dash-table th{
      text-align:left; font-weight:500; padding:.5rem .75rem;
      color: var(--color-muted,#6b7280); border-bottom:1px solid var(--color-border,#e5e7eb);
    }
    .dash-table td{
      padding:.5rem .75rem; border-bottom:1px solid var(--color-border,#e5e7eb);
      color: var(--color-strong,#111827);
    }

    /* dark */
    html.dark .dash-card{ background:#0f172a; border-color:#1f2937; }
    html.dark .dash-card h3, html.dark .dash-card .sub{ color:#cbd5e1; }
    html.dark .dash-card .value{ color:#f8fafc; }
    html.dark .dash-table th{ color:#cbd5e1; border-color:#1f2937; }
    html.dark .dash-table td{ color:#e5e7eb; border-color:#1f2937; }

    .section{ border-radius:12px; border:1px solid var(--color-border,#e5e7eb); background:var(--color-surface,#ffffff); }
    html.dark .section{ background:#0b1220; border-color:#1f2937; }
    .section-header{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--color-border,#e5e7eb); }
    html.dark .section-header{ border-color:#1f2937; }
    .section-title{ font-weight:600; }
    .muted{ color: var(--color-muted,#6b7280); }
    html.dark .muted{ color:#94a3b8; }

    /* tiny bar chart (7-day) */
    .bars{ display:flex; align-items:flex-end; gap:.5rem; height:110px; padding:12px; }
    .bar{
      width:14px; border-radius:6px 6px 0 0; background: var(--brand);
      box-shadow: 0 2px 0 rgba(0,0,0,.05);
    }
    .bar.muted{ background: linear-gradient(180deg, var(--brand) 0%, rgba(124,58,237,.55) 100%); }
    .bar-label{ text-align:center; font-size:.65rem; margin-top:.35rem; color:var(--color-muted,#6b7280); }
    html.dark .bar-label{ color:#94a3b8; }
    .chart-wrap{ padding:8px 12px 14px; }
  </style>
{% endblock %}

{% block content %}
<div class="space-y-6" style="margin-top:.25rem">

  <!-- Header -->
  <div style="display:flex; align-items:baseline; justify-content:space-between;">
    <div class="accent">
      <h1 style="font-size:1.5rem; font-weight:700;">Dashboard</h1>
      <p class="muted">Today: {{ today|date:"M. d, Y" }}</p>
    </div>
    <a href="{% url 'admin:orders_order_add' %}" class="brand-chip">＋ Create order</a>
  </div>

  <!-- Top stats (Users / New users / Products / Orders) -->
  <div class="dash-grid cols-4">
    <div class="dash-card">
      <h3>Total Users</h3>
      <div class="value">{{ stats.users_total }}</div>
      <div class="sub">Active: {{ stats.users_active }} • Guests: {{ stats.users_guests }}</div>
    </div>

    <div class="dash-card">
      <h3>New Users (7 days)</h3>
      <div class="value">{{ stats.users_last7 }}</div>
      <div class="sub">Real users: {{ stats.users_real }}</div>
    </div>

    <div class="dash-card">
      <h3>Products</h3>
      <div class="value">{{ stats.products }}</div>
    </div>

    <div class="dash-card">
      <h3>Orders</h3>
      <div class="value">{{ stats.orders }}</div>
    </div>
  </div>

  <!-- Sales + 7-day chart row -->
  <div class="dash-grid cols-4">
    <!-- Sales (brand accented) -->
    <div class="dash-card" style="grid-column: span 2;">
      <h3>Sales</h3>
      <div class="value" style="display:flex; align-items:baseline; gap:.75rem;">
        <span>{{ stats.sales_total }}</span>
        <span class="brand-chip">Last 7d: {{ stats.sales_7d }}</span>
      </div>
      <div class="sub">Cumulative revenue. Last 7 days highlighted.</div>
    </div>

    <!-- 7-day Orders chart -->
    <div class="dash-card" style="grid-column: span 2;">
      <h3>Orders (7 days)</h3>
      <div class="chart-wrap">
        <div class="bars">
          {# bars scaled by trend_max #}
          {% for p in trend %}
            {% with h=p.count|floatformat:0 %}
              <div class="bar {% if forloop.counter0|divisibleby:2 %}muted{% endif %}"
                   title="{{ p.date|date:'M d' }} — {{ p.count }} orders"
                   style="height: {{ p.count|floatformat:0|add:'0'|floatformat:0|default_if_none:'0'|floatformat:0 }}px;
                          height: calc( ({{ p.count }} / {{ trend_max }}) * 100% );">
              </div>
            {% endwith %}
          {% endfor %}
        </div>
        <div style="display:flex; gap:.5rem; justify-content:space-between; padding:0 12px;">
          {% for p in trend %}
            <div class="bar-label">{{ p.date|date:"d" }}</div>
          {% endfor %}
        </div>
      </div>
      <div class="sub">Scaled to the busiest day ({{ trend_max }} orders).</div>
    </div>
  </div>

  <!-- Status split -->
  <div class="dash-grid cols-5">
    <div class="dash-card"><h3>Pending</h3><div class="value">{{ stats.pending }}</div></div>
    <div class="dash-card"><h3>Processing</h3><div class="value">{{ stats.processing }}</div></div>
    <div class="dash-card"><h3>Shipped</h3><div class="value">{{ stats.shipped }}</div></div>
    <div class="dash-card"><h3>Delivered</h3><div class="value">{{ stats.delivered }}</div></div>
    <div class="dash-card"><h3>Cancelled</h3><div class="value">{{ stats.cancelled }}</div></div>
  </div>

  <!-- Recent orders -->
    <div class="section">
    <div class="section-header">
      <div class="section-title">Recent Orders</div>
      <a href="{% url 'admin:orders_order_changelist' %}" class="brand-chip" style="text-decoration:none;">View all</a>
    </div>
    <div style="padding:12px 16px; overflow-x:auto;">
      <table class="dash-table">
        <thead>
          <tr>
            <th>#</th><th>Customer</th><th>Total</th><th>Status</th><th>Payment</th><th>Created</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for o in recent_orders %}
          <tr>
            <td>#{{ o.id }}</td>
            <td>{% if o.customer %}{{ o.customer.email|default:o.customer }}{% else %}<span class="muted">Guest</span>{% endif %}</td>
            <td>{{ o.total_amount }}</td>
            <td><span class="brand-chip" style="border-color:transparent">{{ o.get_status_display }}</span></td>
            <td class="muted" style="font-size:.8rem">{{ o.payment_type }} / {{ o.payment_status }}</td>
            <td>{{ o.created_at|date:"Y-m-d H:i" }}</td>
            <td><a class="brand-chip" href="{% url 'admin:orders_order_change' o.id %}">Open</a></td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="muted">No orders yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

  <!-- Top Categories / Top Products -->
  <div class="dash-grid cols-4">
    <div class="section" style="grid-column: span 2;">
      <div class="section-header">
        <div class="section-title">Top Categories (by Revenue)</div>
      </div>
      <div style="padding:12px 16px;">
        <table class="dash-table">
          <thead><tr><th>Category</th><th>Qty</th><th>Revenue</th></tr></thead>
          <tbody>
            {% for c in top_categories %}
            <tr>
              <td>{{ c.name|default:"(Uncategorized)" }}</td>
              <td>{{ c.qty|default:0 }}</td>
              <td>{{ c.revenue|default:0 }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="muted">No data.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="section" style="grid-column: span 2;">
      <div class="section-header">
        <div class="section-title">Top Products (by Revenue)</div>
      </div>
      <div style="padding:12px 16px;">
        <table class="dash-table">
          <thead><tr><th>Product</th><th>Qty</th><th>Revenue</th></tr></thead>
          <tbody>
            {% for p in top_products %}
            <tr>
              <td>{{ p.name|default:"(Unnamed Product)" }}</td>
              <td>{{ p.qty|default:0 }}</td>
              <td>{{ p.revenue|default:0 }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="muted">No data.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}
